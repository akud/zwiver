<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"  
      "http://www.w3.org/TR/html4/loose.dtd">  
<html>  
  <head>  
    <link rel="stylesheet" href="qunit.css" type="text/css"/>  
    <script type="text/javascript" src="/js/libs/jquery-1.7.2.min.js"></script>  
    <script type="text/javascript" src="qunit.js"></script>  
    <!-- defaults for Ember -->
    <script type="text/javascript" >
      ENV = {
        CP_DEFAULT_CACHEABLE: true,
        VIEW_PRESERVES_CONTEXT: true
      };
    </script>
    <script type="text/javascript" src="/js/libs/ember-0.9.8.1.js"></script>  
    <script type="text/javascript" 
      src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAPy-D421ZfcuKJZO-qDhG7ndbYloXWqWs&sensor=false"></script>
    <script type="text/javascript" src="/js/events.js"></script>  
    <script type="text/javascript">  
    $(document).ready(function(){  
      /***********Basic Definitions***************/
      module('Core');  
      test('Required Objects', function(){  
        expect(7);    
        ok(Events, 'Events');
        ok(EV, 'EV');
        strictEqual(EV, Events, 'EV === Events');
        ok(EV.Event, 'Event Class');
        ok(EV.eventsController, 'eventsController');
        ok(EV.listView, 'listView');
        ok(EV.mapView, 'mapView');
      });  

      test('EV.toApiUrl', function() {
        expect(10);
        ok(!EV.toApiUrl(), 'toApiUrl with no argument');
        ok(!EV.toApiUrl(null), 'toApiUrl with null');
        equal(EV.toApiUrl('/events'), '/api/events', 'relative path');
        equal(EV.toApiUrl('events'), '/api/events', 'relative path no slash');
        equal(EV.toApiUrl('/api/events'), '/api/events', 'already correct path');
        equal(EV.toApiUrl('http://localhost:8080/api/events'), '/api/events', 'http with port');
        equal(EV.toApiUrl('http://localhost/api/events'), '/api/events', 'http no port');
        equal(EV.toApiUrl('http://www.zwiver.com/api/events'), '/api/events', 'http www');
        equal(EV.toApiUrl('www.zwiver.com/api/events'), '/api/events', 'start with www');
        equal(EV.toApiUrl('zwiver.com/api/events'), '/api/events', 'url no http');
      });


      /**************Events Model******************/
      module('Models');
      test('Events Model', function(){
        expect(13);
        var desc = 'I donâ€™t feel that it is necessary to know' + 
        ' exactly what I am. The main interest in life and work' + 
        ' is to become someone else that you were not in the beginning.' + 
        ' If you knew when you began a book what you would say at the end,' + 
        ' do you think that you would have the courage to write it?' + 
        ' What is true for writing and for love relationships is true' + 
        ' also for life. The game is worthwhile insofar as we don\'t' + 
        ' know where it will end.';
        var ev = EV.Event.create({
          description: desc,
          lat: 35.32145,
          lon: -124.53435,
          date: '2012-07-15T01:30:00Z'
        });
        equal(ev.get('formattedDate'),'July 14 6:30pm','formatted date');

        ok(ev.get('shortDescription'),'short description');
        ok(ev.get('shortDescription').length < desc.length, 
          'shortDescription.length < description.length');
        strictEqual(ev.get('hasMore'), true, 'hasMore == true for long description');

        ok(ev.get('position'), 'position');
        equal(Math.round(ev.get('position').lat()), 35,
          'correct latitude for position');
        equal(Math.round(ev.get('position').lng()), -125, 
          'correct longitude for position');
        ok(ev.get('mapMarker'), 'map marker');
        equal(ev.get('mapMarker').getPosition(), ev.get('position'), 
          'correct position for map marker');

        ok(ev.get('infoWindowContent'), 'info window content');
        ok(ev.get('infoWindow'), 'info window');  
        equal(ev.get('infoWindow').getPosition(), ev.get('position'), 
          'correct position for info window');
        equal(ev.get('infoWindow').getContent(), ev.get('infoWindowContent'),
          'correct content for info window');
      });

      /***************Events Controller****************/  
      module('Controllers');
      test('Events Controller', function() {
        expect(10);
        var ev = EV.Event.create({
          title: 'test title',
          description: 'foo',
          lat: 32.534,
          lon: -123.324
        });
        EV.eventsController.select(ev);
        equal(EV.eventsController.get('selectedEvent'), ev, 
          'selects correct event');
        QUnit.stop();
        setTimeout(function(){
          var length = EV.eventsController.get('length');
          ok(!!length, 'Controller loads content on init')
          ok(EV.eventsController.everyProperty('title'), 'Every event has a title');
          ok(EV.eventsController.everyProperty('date'), 'Every event has a date');
          ok(EV.eventsController.everyProperty('id'), 'Every event has an id');

          var initialIds = EV.eventsController.map(function(evt){return evt.get('id');});

          EV.eventsController.loadNext();
          QUnit.stop();
          setTimeout(function() {
            equal(EV.eventsController.get('length'), length, 
              'loadNext() returns the same number of events as initial load')
            //qunit doesn't have a notDeepEqual(), so we have to go through 
            //some contortions to check that loadNext() actually returned a separate 
            //set of ids
            //for every event loaded by loadNext()...
            ok(EV.eventsController.every(function(evt) {
              //it should be true that for every event in the initial load...
              return initialIds.every(function(id) {
                //that event is not equal to the current one
                return id != evt.get('id');
              });
            }), 'loadNext returns a different set of ids');
            ok(EV.eventsController.get('previousUrl'), 'loadNext() sets the prev url');

            EV.eventsController.loadPrevious();
            QUnit.stop();
            setTimeout(function() {
              equal(EV.eventsController.get('length'), length, 
                'loadPrevious() returns same number of events as initial load')
              var ids = EV.eventsController.map(function(evt){return evt.get('id');})
              deepEqual(ids, initialIds, 'loadPrevious returns the previous list of events');
              QUnit.start();
            }, 250);
            QUnit.start(); 
          }, 250);
          QUnit.start();
        }, 50);
      });

      /********************List View******************/
      module('Views');
      test('ListView', function() {
        expect(11);
        equal(EV.listView.get('content'), EV.eventsController.get('content'), 
          'Controller Binding');
        
        //append to the dom
        EV.listView.appendTo('#qunit-fixture');

        QUnit.stop();
        setTimeout(function() {
          equal($('#qunit-fixture li.list-item').length, 
            EV.eventsController.get('length'), 
            'appending creates list elements');  

          var childViews = EV.listView.get('childViews');
          ok(!!childViews.length, 'creates child views');

          //check click behavior
          ok(childViews.everyProperty('selected',false), 
            'views are unselected by default');
          $('#qunit-fixture li.list-item')[0].click();
          QUnit.stop();
          setTimeout(function() {
            ok(childViews[0].get('selected'),'click selects element');
            ok(!childViews.everyProperty('selected'), 'click selected all elements');
            equal(childViews[0].get('content'), 
              EV.eventsController.get('selectedEvent'), 
              'Click sets selected event on events controller');

              //select another item
            $('#qunit-fixture li.list-item')[1].click();
            QUnit.stop();
            setTimeout(function() {
              ok(childViews[1].get('selected'),'click selects new element');
              ok(!childViews[0].get('selected'),'click deselects old element');

              //click the 'show more' link
              $('#qunit-fixture li.list-item:nth-child(2) span.show-more').click();
              QUnit.stop();
              setTimeout(function() {
                strictEqual(childViews[1].get('selected'), true, 
                  'click on show more selects list item');  
                strictEqual(childViews[1].get('expanded'), true, 
                  'click on show more expands list item');  
                QUnit.start();
              }, 20);

              QUnit.start();
            }, 20);
            QUnit.start();
          }, 20);
          QUnit.start();
        }, 20);
      });
  
      /******************Map View*****************/
      test('MapView', function() {
        expect(3);
        EV.mapView.appendTo('#qunit-fixture');
        QUnit.stop();
        setTimeout(function() {
          var map = EV.mapView.get('map');
          ok(map,'creates map object');
          //the map should have appended a bunch of div children
          ok($('#qunit-fixture div').length > 10, 'appends map elements');
          
          var ev = EV.Event.create({
            lat: 30.129,
            lon: 129.34,
            title: 'test title',
            description: 'foo'
          });

          EV.eventsController.select(ev);
          QUnit.stop();
          setTimeout(function() {
            equal(Math.round(EV.mapView.get('map').getCenter().lat()), 
              Math.round(ev.get('position').lat()),
              'selecting an event pans the map');
            /*
            TODO: why aren't info windows opening in the tests?
            ok(!!$('div.info-window-title').length, 
              'selecting an event opens the info window')
            equal($('div.info-window-title').text(), ev.get('title'),
              'open info window has correct title');
            */
            QUnit.start();
          }, 25);
        QUnit.start();
        }, 150);
      });
    });  
    </script>  
  </head>  
  <body>  
    <h1 id="qunit-header">Events QUnit Tests</h1>  
    <h2 id="qunit-banner"></h2>  
    <h2 id="qunit-userAgent"></h2>  
    <ol id="qunit-tests">  
    </ol>  
    <div id="qunit-fixture">test markup, will be hidden</div>
    <script type="text/x-handlebars" data-template-name="list-item">
      List Item {{#view view.showMoreView}} 
        Wrapped in show more
      {{/view}}
    </script>
  </body>
</html>  
